# 持仓管理 API

## 1. 持仓列表

### 接口信息

- **路径**: `/api/positions/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取当前用户的所有持仓

### 请求头

```
Authorization: Bearer <access_token>
```

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | uuid | 否 | 按账户过滤 |

### 响应示例

```json
[
  {
    "id": "uuid-string",
    "account": "uuid-string",
    "fund": {
      "fund_code": "000001",
      "fund_name": "华夏成长混合",
      "fund_type": "混合型"
    },
    "holding_share": "1000.00",
    "holding_cost": "12345.00",
    "avg_nav": "12.345",
    "pnl": "123.45",
    "pnl_rate": "1.00%",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-02T00:00:00Z"
  }
]
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 持仓 ID |
| account | uuid | 账户 ID |
| fund | object | 基金信息 |
| holding_share | decimal | 持有份额 |
| holding_cost | decimal | 持有成本 |
| avg_nav | decimal | 平均净值 |
| pnl | decimal | 盈亏金额（基于昨日净值） |
| pnl_rate | string | 盈亏率 |

### 状态码

- `200` - 成功
- `401` - 未认证

---

## 2. 持仓详情

### 接口信息

- **路径**: `/api/positions/{id}/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取持仓详细信息

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 持仓 ID |

### 响应示例

```json
{
  "id": "uuid-string",
  "account": "uuid-string",
  "fund": {
    "fund_code": "000001",
    "fund_name": "华夏成长混合",
    "fund_type": "混合型"
  },
  "holding_share": "1000.00",
  "holding_cost": "12345.00",
  "avg_nav": "12.345",
  "pnl": "123.45",
  "pnl_rate": "1.00%",
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-02T00:00:00Z"
}
```

### 状态码

- `200` - 成功
- `401` - 未认证
- `404` - 持仓不存在

---

## 3. 重算持仓（管理员）

### 接口信息

- **路径**: `/api/positions/recalculate/`
- **方法**: `POST`
- **认证**: 需要（管理员）
- **描述**: 根据操作流水重新计算持仓

### 请求参数

```json
{
  "account_id": "uuid-string"
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account_id | uuid | 否 | 指定账户 ID，不填则重算所有账户 |

### 响应示例

```json
{
  "message": "重算完成"
}
```

### 状态码

- `200` - 重算成功
- `401` - 未认证
- `403` - 无权限（非管理员）

---

## 4. 操作流水列表

### 接口信息

- **路径**: `/api/positions/operations/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取持仓操作流水

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | uuid | 否 | 按账户过滤 |
| fund_code | string | 否 | 按基金代码过滤 |

### 响应示例

```json
[
  {
    "id": "uuid-string",
    "account": "uuid-string",
    "fund": {
      "fund_code": "000001",
      "fund_name": "华夏成长混合"
    },
    "operation_type": "BUY",
    "operation_date": "2024-01-01",
    "before_15": true,
    "amount": "10000.00",
    "share": "800.00",
    "nav": "12.50",
    "created_at": "2024-01-01T10:00:00Z"
  }
]
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 操作 ID |
| account | uuid | 账户 ID |
| fund | object | 基金信息 |
| operation_type | string | 操作类型：BUY（建仓/加仓）、SELL（减仓） |
| operation_date | date | 操作日期 |
| before_15 | boolean | 是否 15:00 前操作 |
| amount | decimal | 金额 |
| share | decimal | 份额 |
| nav | decimal | 净值 |

### 状态码

- `200` - 成功
- `401` - 未认证

---

## 5. 创建操作流水

### 接口信息

- **路径**: `/api/positions/operations/`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 创建持仓操作记录（建仓/加仓/减仓）

### 请求参数

```json
{
  "account": "uuid-string",
  "fund_code": "000001",
  "operation_type": "BUY",
  "operation_date": "2024-01-01",
  "before_15": true,
  "amount": "10000.00",
  "share": "800.00",
  "nav": "12.50"
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | uuid | 是 | 账户 ID |
| fund_code | string | 是 | 基金代码 |
| operation_type | string | 是 | 操作类型：BUY 或 SELL |
| operation_date | date | 是 | 操作日期 |
| before_15 | boolean | 否 | 是否 15:00 前操作，默认 false |
| amount | decimal | 是 | 金额 |
| share | decimal | 是 | 份额 |
| nav | decimal | 是 | 净值 |

### 响应示例

```json
{
  "id": "uuid-string",
  "account": "uuid-string",
  "fund": {
    "fund_code": "000001",
    "fund_name": "华夏成长混合"
  },
  "operation_type": "BUY",
  "operation_date": "2024-01-01",
  "before_15": true,
  "amount": "10000.00",
  "share": "800.00",
  "nav": "12.50",
  "created_at": "2024-01-01T10:00:00Z"
}
```

### 状态码

- `201` - 创建成功
- `400` - 参数错误
- `401` - 未认证

---

## 6. 操作流水详情

### 接口信息

- **路径**: `/api/positions/operations/{id}/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取操作流水详情

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 操作 ID |

### 响应示例

```json
{
  "id": "uuid-string",
  "account": "uuid-string",
  "fund": {
    "fund_code": "000001",
    "fund_name": "华夏成长混合"
  },
  "operation_type": "BUY",
  "operation_date": "2024-01-01",
  "before_15": true,
  "amount": "10000.00",
  "share": "800.00",
  "nav": "12.50",
  "created_at": "2024-01-01T10:00:00Z"
}
```

### 状态码

- `200` - 成功
- `401` - 未认证
- `404` - 操作不存在

---

## 7. 删除操作流水（管理员）

### 接口信息

- **路径**: `/api/positions/operations/{id}/`
- **方法**: `DELETE`
- **认证**: 需要（管理员）
- **描述**: 删除操作流水记录

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 操作 ID |

### 响应

无响应体

### 状态码

- `204` - 删除成功
- `401` - 未认证
- `403` - 无权限（非管理员）
- `404` - 操作不存在

### 注意事项

- 删除操作后需要重新计算持仓
- 建议删除后调用 `/api/positions/recalculate/` 重算持仓
